---
title: zk-rollup
date: 2023-03-08 17:07:22
tags: layer2
---

# zkRollup：以太坊扩容新方案

## 引言

以太坊是当前全球最大的智能合约平台，它拥有着大量的用户和开发者，但同时也存在着一些问题，例如：网络拥堵、交易费用过高等。为了解决这些问题，以太坊社区提出了很多方案，其中 zkRollup（Zero-Knowledge Rollup）是其中的一种，它是一种新的扩容方案，可以在不牺牲去中心化和安全性的前提下提高以太坊的吞吐量，本文将详细介绍 zkRollup 的原理和优缺点。

## 背景

随着区块链技术的不断发展，越来越多的项目开始关注区块链的可扩展性问题。由于以太坊的 TPS（每秒交易数）仅为 15 左右，无法满足大规模商用应用的需求，因此 Layer 2 技术开始成为了研究的热点。

Layer 2 技术可以将一部分交易从区块链的主链上转移到链上的第二层，从而减少主链的负载，提高整个系统的性能。常见的 Layer 2 技术包括状态通道（State Channels）、Plasma、Sidechain 等。

然而，这些技术中的大部分都需要信任第三方，容易被攻击。为了解决这一问题，一种名为 ZK-Rollup 的技术应运而生。

## 传统扩容方案

在介绍 zkRollup 前，我们先来看看传统的以太坊扩容方案，主要有以下几种：

### 1. 分片技术

分片技术是当前以太坊正在积极研究的方案之一，它的核心思想是将整个以太坊网络分成多个小网络，每个小网络独立处理交易，这样就可以大大提高网络的吞吐量。分片技术有很多优点，例如：它可以不影响以太坊的去中心化和安全性，同时也可以降低交易费用，提高处理速度等。但分片技术也存在着一些问题，例如：难以实现跨片交易，容易出现“碎片化”的情况等。

### 2. Plasma 技术

Plasma 技术是一种以太坊扩容方案，它的核心思想是将一些交易放到侧链中进行处理，这样可以大大提高以太坊的吞吐量，同时也可以降低交易费用。Plasma 技术也有很多优点，例如：它可以降低交易费用，提高处理速度，同时还可以保持去中心化和安全性等。但 Plasma 技术也存在着一些问题，例如：容易出现链下交易问题，安全性难以保证等。

## ZK-Rollup 的基本思想

ZK-Rollup 的基本思想是将所有的交易放在链上的第二层中进行处理，而不是直接放在主链上。同时，为了避免第二层出现不一致的情况，ZK-Rollup 使用了零知识证明来确保每个交易都是有效的。

在 ZK-Rollup 中，每个区块都包含了大量的交易信息。这些交易信息被打包成一个 Merkle 树，并生成对应的零知识证明。这个证明能够证明这个 Merkle 树中的某些交易是有效的。

在新的区块生成之前，会先对当前区块进行验证。这个验证过程包括两部分：

1. 验证交易的合法性：对于 Merkle 树中的每个交易，都需要进行验证，确保其符合所有的交易规则（例如，交易双方的签名是有效的、交易的金额不为负数等等）。

2. 验证零知识证明的正确性：如果交易合法，则需要对 Merkle 树生成的零知识证明进行验证，确保它是正确的。

验证通过之后，新的区块就会被添加到链上。

## zkRollup 的原理

zkRollup 是一个采用零知识证明实现的二层扩容方案，它通过将交易数据存储在链下的状态树中，实现了在链上仅记录状态树根哈希值的方式，从而在保证安全性的同时大幅提升了交易吞吐量。

具体来说，zkRollup 的实现原理如下：

### 1. 状态树

zkRollup 使用状态树来存储交易数据，每个叶节点表示一个账户，每个内部节点表示一个状态集合，每个状态集合包含其所有子节点所代表账户的状态的哈希值。

### 2. 交易提交

当用户发起一笔交易时，zkRollup 需要进行以下操作：

1. 检查交易的合法性。
2. 从状态树中读取与交易相关的账户状态。
3. 计算出交易后账户状态的哈希值。
4. 将交易打包成一个交易证明，交易证明包含交易本身以及新的状态哈希值。
5. 将交易证明提交到以太坊网络，zkRollup 合约接收到交易证明后，更新状态树。

### 3. 状态验证

zkRollup 的状态验证是通过零知识证明实现的。zkRollup 中的每一个状态集合都对应一个零知识证明，证明该状态集合中所有账户状态的正确性。这个证明可以被用来验证状态树中任何一个状态是否合法。

### 4. 合约操作

zkRollup 的合约操作主要包括以下三种：

1. Deposit：用户将以太币存入 zkRollup 合约，合约会生成一份对应的状态证明，并在状态树中新增一个叶子节点。
2. Withdraw：用户提取存入合约的以太币，合约会验证用户的提现请求，然后删除状态树中对应的叶子节点，并生成一份对应的状态证明。
3. Transfer：用户在不同账户之间进行转账操作，合约会验证转账请求的合法性，并更新状态树中相关账户的状态。

### 5. 优势与劣势

zkRollup 的主要优势在于能够大幅提升以太坊的交易吞吐量，同时保证了链上交易的安全性。与此同时，zkRollup 的缺点在于需要使用零知识证明来实现状态验证，这导致了 zkRollup 的实现难度和成本较高。









